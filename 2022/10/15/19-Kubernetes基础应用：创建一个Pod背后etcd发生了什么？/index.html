

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/%E5%AD%A6%E6%A0%A1.png">
  <link rel="icon" href="/img/%E5%AD%A6%E6%A0%A1.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="lp">
  <meta name="keywords" content="">
  
    <meta name="description" content="极客时间etcd课程笔记">
<meta property="og:type" content="article">
<meta property="og:title" content="19.Kubernetes基础应用：创建一个Pod背后etcd发生了什么？">
<meta property="og:url" content="https://blog.longpi1.com/2022/10/15/19-Kubernetes%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8%EF%BC%9A%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AAPod%E8%83%8C%E5%90%8Eetcd%E5%8F%91%E7%94%9F%E4%BA%86%E4%BB%80%E4%B9%88%EF%BC%9F/index.html">
<meta property="og:site_name" content="lp&#39;s blog">
<meta property="og:description" content="极客时间etcd课程笔记">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/b1/c0/b13d665a0e5be852c050d09c8602e4c0.png?wh=1920*831">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/56/bc/561f38086df49d17ee4e12ec3c5220bc.png?wh=1920*1078">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/4d/09/4d8fa0f1d6afd89cf6463cf22c56b709.png?wh=1920*1178">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/89/54/89c610a5e5bc2bf5eda466a5a0e18e54.png?wh=1740*1456">
<meta property="article:published_time" content="2022-10-14T16:16:32.000Z">
<meta property="article:modified_time" content="2022-10-21T14:02:31.116Z">
<meta property="article:author" content="lp">
<meta property="article:tag" content="原创">
<meta property="article:tag" content="Kubernetes">
<meta property="article:tag" content="etcd">
<meta property="article:tag" content="笔记">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://static001.geekbang.org/resource/image/b1/c0/b13d665a0e5be852c050d09c8602e4c0.png?wh=1920*831">
  
  
  
  <title>19.Kubernetes基础应用：创建一个Pod背后etcd发生了什么？ - lp&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"blog.longpi1.com","root":"/","version":"1.9.2","typing":{"enable":true,"typeSpeed":30,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":"UvaCwj6C0pVj9XCWuMtLaBWJ-gzGzoHsz","app_key":"w2xUk9wycItSqrREmRMDYJHY","server_url":"https://uvacwj6c.lc-cn-n1-shared.com","path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  

  

  

  

  

  

  

  
    
  



  
<meta name="generator" content="Hexo 6.2.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>lp&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                文章分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于我
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/bg.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="19.Kubernetes基础应用：创建一个Pod背后etcd发生了什么？"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-10-15 00:16" pubdate>
          2022年10月15日 凌晨
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          16k 字
        
      </span>
    

  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>


    <a target="_blank" rel="noopener" href="https://github.com/longpi1"><img loading="lazy" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_left_darkblue_121621.png?resize=149%2C149" srcset="/img/loading.gif" lazyload class="attachment-full size-full" alt="follow me on GitHub" data-recalc-dims="1"></a>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">19.Kubernetes基础应用：创建一个Pod背后etcd发生了什么？</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="19-Kubernetes基础应用：创建一个Pod背后etcd发生了什么？"><a href="#19-Kubernetes基础应用：创建一个Pod背后etcd发生了什么？" class="headerlink" title="19.Kubernetes基础应用：创建一个Pod背后etcd发生了什么？"></a>19.Kubernetes基础应用：创建一个Pod背后etcd发生了什么？</h1><blockquote>
<p>本文笔记来自：「极客时间ETCD实战课」，原文链接：<a target="_blank" rel="noopener" href="https://time.geekbang.org/column/article/354292?cid=100069901">https://time.geekbang.org/column/article/354292?cid=100069901</a></p>
</blockquote>
<p>今天我们通过在Kubernetes集群中创建一个Pod的案例，分析etcd在其中发挥的作用，深入了解Kubernetes是如何使用etcd的。</p>
<h2 id="Kubernetes基础架构"><a href="#Kubernetes基础架构" class="headerlink" title="Kubernetes基础架构"></a>Kubernetes基础架构</h2><p>在详细了解etcd在Kubernetes里的应用之前，先简单介绍下Kubernetes集群的整体架构，搞清楚etcd在Kubernetes集群中扮演的角色与作用。</p>
<p>下图是Kubernetes集群的架构图（ <a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/overview/components/">引用自Kubernetes官方文档</a>），从图中你可以看到，它由Master节点和Node节点组成。</p>
<p><img src="https://static001.geekbang.org/resource/image/b1/c0/b13d665a0e5be852c050d09c8602e4c0.png?wh=1920*831" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>控制面Master节点主要包含以下组件：</p>
<ul>
<li>kube-apiserver，负责对外提供集群各类资源的增删改查及Watch接口，它是Kubernetes集群中各组件数据交互和通信的枢纽。kube-apiserver在设计上可水平扩展，高可用Kubernetes集群中一般多副本部署。当收到一个创建Pod写请求时，它的基本流程是对请求进行认证、限速、授权、准入机制等检查后，写入到etcd即可。</li>
<li>kube-scheduler是调度器组件，负责集群Pod的调度。基本原理是通过监听kube-apiserver获取待调度的Pod，然后基于一系列筛选和评优算法，为Pod分配最佳的Node节点。</li>
<li>kube-controller-manager包含一系列的控制器组件，比如Deployment、StatefulSet等控制器。控制器的核心思想是监听、比较资源实际状态与期望状态是否一致，若不一致则进行协调工作使其最终一致。</li>
<li>etcd组件，Kubernetes的元数据存储。</li>
</ul>
<p>Node节点主要包含以下组件：</p>
<ul>
<li>kubelet，部署在每个节点上的Agent的组件，负责Pod的创建运行。基本原理是通过监听APIServer获取分配到其节点上的Pod，然后根据Pod的规格详情，调用运行时组件创建pause和业务容器等。</li>
<li>kube-proxy，部署在每个节点上的网络代理组件。基本原理是通过监听APIServer获取Service、Endpoint等资源，基于Iptables、IPVS等技术实现数据包转发等功能。</li>
</ul>
<p>从Kubernetes基础架构介绍中可以看到，kube-apiserver是唯一直接与etcd打交道的组件，各组件都通过kube-apiserver实现数据交互，它们极度依赖kube-apiserver提供的资源变化 <strong>监听机制</strong>。而kube-apiserver对外提供的监听机制，也正是etcd <strong>Watch特性</strong> 提供的底层支持。</p>
<h2 id="创建Pod案例"><a href="#创建Pod案例" class="headerlink" title="创建Pod案例"></a>创建Pod案例</h2><p>接下来就以在Kubernetes集群中创建一个nginx服务为例，通过这个案例来详细分析etcd在Kubernetes集群创建Pod背后是如何工作的。</p>
<p>下面是创建一个nginx服务的YAML文件，Workload是Deployment，期望的副本数是1。</p>
<figure class="highlight nestedtext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs nestedtext"><span class="hljs-attribute">apiVersion</span><span class="hljs-punctuation">:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attribute">kind</span><span class="hljs-punctuation">:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attribute">metadata</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">name</span><span class="hljs-punctuation">:</span> <span class="hljs-string">nginx-deployment</span><br>  <span class="hljs-attribute">labels</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">app</span><span class="hljs-punctuation">:</span> <span class="hljs-string">nginx</span><br><span class="hljs-attribute">spec</span><span class="hljs-punctuation">:</span><br>  <span class="hljs-attribute">replicas</span><span class="hljs-punctuation">:</span> <span class="hljs-string">1</span><br>  <span class="hljs-attribute">selector</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">matchLabels</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-attribute">app</span><span class="hljs-punctuation">:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attribute">template</span><span class="hljs-punctuation">:</span><br>    <span class="hljs-attribute">metadata</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-attribute">labels</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-attribute">app</span><span class="hljs-punctuation">:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attribute">spec</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-attribute">containers</span><span class="hljs-punctuation">:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">name: nginx</span><br>        <span class="hljs-attribute">image</span><span class="hljs-punctuation">:</span> <span class="hljs-string">nginx:1.14.2</span><br>        <span class="hljs-attribute">ports</span><span class="hljs-punctuation">:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">containerPort: 80</span><br><br></code></pre></td></tr></table></figure>

<p>假设此YAML文件名为nginx.yaml，首先通过如下的kubectl create -f nginx.yml命令创建Deployment资源。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs powershell"><span class="hljs-variable">$</span> kubectl create <span class="hljs-operator">-f</span> nginx.yml<br>deployment.apps/nginx<span class="hljs-literal">-deployment</span> created<br><br></code></pre></td></tr></table></figure>

<p>创建之后，我们立刻通过如下命令，带标签查询Pod，输出如下：</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs routeros">$ kubectl <span class="hljs-built_in">get</span> po -l <span class="hljs-attribute">app</span>=nginx<br>NAME                                READY   STATUS    RESTARTS   AGE<br>nginx-deployment-756d9fd5f9-fkqnf   1/1     Running   0          8s<br><br></code></pre></td></tr></table></figure>

<p>那么在kubectl create命令发出，nginx Deployment资源成功创建的背后，kube-apiserver是如何与etcd打交道的呢？ 它是通过什么接口 <strong>安全写入</strong> 资源到etcd的？</p>
<p>同时，使用kubectl带标签查询Pod背后，kube-apiserver是直接从 <strong>缓存读取</strong> 还是向etcd发出一个 <strong>线性读</strong> 或 <strong>串行读</strong> 请求呢？ 若同namespace下存在大量的Pod，此操作性能又是怎样的呢?</p>
<p>接下来聊聊kube-apiserver收到创建和查询请求后，是如何与etcd交互的。</p>
<h2 id="kube-apiserver请求执行链路"><a href="#kube-apiserver请求执行链路" class="headerlink" title="kube-apiserver请求执行链路"></a>kube-apiserver请求执行链路</h2><p>kube-apiserver作为Kubernetes集群交互的枢纽、对外提供API供用户访问的组件，因此保障集群安全、保障本身及后端etcd的稳定性的等重任也是非它莫属。比如校验创建请求发起者是否合法、是否有权限操作相关资源、是否出现Bug产生大量写和读请求等。</p>
<p><a target="_blank" rel="noopener" href="https://speakerdeck.com/sttts/kubernetes-api-codebase-tour?slide=18">下图是kube-apiserver的请求执行链路</a>（引用自sttts分享的PDF），当收到一个请求后，它主要经过以下处理链路来完成以上若干职责后，才能与etcd交互。</p>
<p>核心链路如下：</p>
<ul>
<li>认证模块，校验发起的请求的用户身份是否合法。支持多种方式，比如x509客户端证书认证、静态token认证、webhook认证等。</li>
<li>限速模块，对请求进行简单的限速，默认读400&#x2F;s写200&#x2F;s，不支持根据请求类型进行分类、按优先级限速，存在较多问题。Kubernetes 1.19后已新增Priority and Fairness特性取代它，它支持将请求重要程度分类进行限速，支持多租户，可有效保障Leader选举之类的高优先级请求得到及时响应，能防止一个异常client导致整个集群被限速。</li>
<li>审计模块，可记录用户对资源的详细操作行为。</li>
<li>授权模块，检查用户是否有权限对其访问的资源进行相关操作。支持多种方式，RBAC(Role-based access control)、ABAC(Attribute-based access control)、Webhhook等。Kubernetes 1.12版本后，默认授权机制使用的RBAC。</li>
<li>准入控制模块，提供在访问资源前拦截请求的静态和动态扩展能力，比如要求镜像的拉取策略始终为AlwaysPullImages。</li>
</ul>
<p><img src="https://static001.geekbang.org/resource/image/56/bc/561f38086df49d17ee4e12ec3c5220bc.png?wh=1920*1078" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>经过上面一系列的模块检查后，这时kube-apiserver就开始与etcd打交道了。在了解kube-apiserver如何将我们创建的Deployment资源写入到etcd前，先介绍下Kubernetes的资源是如何组织、存储在etcd中。</p>
<h2 id="Kubernetes资源存储格式"><a href="#Kubernetes资源存储格式" class="headerlink" title="Kubernetes资源存储格式"></a>Kubernetes资源存储格式</h2><p>etcd仅仅是个key-value存储，但是在Kubernetes中存在各种各样的资源，并提供了以下几种灵活的资源查询方式：</p>
<ul>
<li>按具体资源名称查询，比如PodName、kubectl get po&#x2F;PodName。</li>
<li>按namespace查询，获取一个namespace下的所有Pod，比如kubectl get po -n kube-system。</li>
<li>按标签名，标签是极度灵活的一种方式，你可以为你的Kubernetes资源打上各种各样的标签，比如上面案例中的kubectl get po -l app&#x3D;nginx。</li>
</ul>
<p>你知道以上这几种查询方式它们的性能优劣吗？假设你是Kubernetes开发者，你会如何设计存储格式来满足以上功能点？</p>
<p>首先是按具体资源名称查询。它本质就是个key-value查询，只需要写入etcd的key名称与资源key一致即可。</p>
<p>其次是按namespace查询。这种查询也并不难。因为我们知道etcd支持范围查询，若key名称前缀包含namespace、资源类型，查询的时候指定namespace和资源类型的组合的最小开始区间、最大结束区间即可。</p>
<p>最后是标签名查询。这种查询方式非常灵活，业务可随时添加、删除标签，各种标签可相互组合。实现标签查询的办法主要有以下两种：</p>
<ul>
<li>方案一，在etcd中存储标签数据，实现通过标签可快速定位（时间复杂度O(1)）到具体资源名称。然而一个标签可能容易实现，但是在Kubernetes集群中，它支持按各个标签组合查询，各个标签组合后的数量相当庞大。在etcd中维护各种标签组合对应的资源列表，会显著增加kube-apiserver的实现复杂度，导致更频繁的etcd写入。</li>
<li>方案二，在etcd中不存储标签数据，而是由kube-apiserver通过范围遍历etcd获取原始数据，然后基于用户指定标签，来筛选符合条件的资源返回给client。此方案优点是实现简单，但是大量标签查询可能会导致etcd大流量等异常情况发生。</li>
</ul>
<p>那么Kubernetes集群选择的是哪种实现方式呢?</p>
<p>下面是一个Kubernetes集群中的coredns一系列资源在etcd中的存储格式：</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs awk"><span class="hljs-regexp">/registry/</span>clusterrolebindings/system:coredns<br><span class="hljs-regexp">/registry/</span>clusterroles/system:coredns<br><span class="hljs-regexp">/registry/</span>configmaps<span class="hljs-regexp">/kube-system/</span>coredns<br><span class="hljs-regexp">/registry/</span>deployments<span class="hljs-regexp">/kube-system/</span>coredns<br><span class="hljs-regexp">/registry/</span>events<span class="hljs-regexp">/kube-system/</span>coredns-<span class="hljs-number">7</span>fcc6d65dc-<span class="hljs-number">6</span>njlg.<span class="hljs-number">1662</span>c287aabf742b<br><span class="hljs-regexp">/registry/</span>events<span class="hljs-regexp">/kube-system/</span>coredns-<span class="hljs-number">7</span>fcc6d65dc-<span class="hljs-number">6</span>njlg.<span class="hljs-number">1662</span>c288232143ae<br><span class="hljs-regexp">/registry/</span>pods<span class="hljs-regexp">/kube-system/</span>coredns-<span class="hljs-number">7</span>fcc6d65dc-jvj26<br><span class="hljs-regexp">/registry/</span>pods<span class="hljs-regexp">/kube-system/</span>coredns-<span class="hljs-number">7</span>fcc6d65dc-mgvtb<br><span class="hljs-regexp">/registry/</span>pods<span class="hljs-regexp">/kube-system/</span>coredns-<span class="hljs-number">7</span>fcc6d65dc-whzq9<br><span class="hljs-regexp">/registry/</span>replicasets<span class="hljs-regexp">/kube-system/</span>coredns-<span class="hljs-number">7</span>fcc6d65dc<br><span class="hljs-regexp">/registry/</span>secrets<span class="hljs-regexp">/kube-system/</span>coredns-token-hpqbt<br><span class="hljs-regexp">/registry/</span>serviceaccounts<span class="hljs-regexp">/kube-system/</span>coredns<br><br></code></pre></td></tr></table></figure>

<p>从中我们可以看到，一方面Kubernetes资源在etcd中的存储格式由prefix + “&#x2F;“ + 资源类型 + “&#x2F;“ + namespace + “&#x2F;“ + 具体资源名组成，基于etcd提供的范围查询能力，非常简单地支持了按具体资源名称查询和namespace查询。</p>
<p>kube-apiserver提供了如下参数给你配置etcd prefix，并支持将资源存储在多个etcd集群。</p>
<figure class="highlight livecodeserver"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs livecodeserver"><span class="hljs-comment">--etcd-prefix string     Default: &quot;/registry&quot;</span><br>The prefix <span class="hljs-built_in">to</span> prepend <span class="hljs-built_in">to</span> all resource paths <span class="hljs-keyword">in</span> etcd.<br><span class="hljs-comment">--etcd-servers stringSlice</span><br>List <span class="hljs-keyword">of</span> etcd servers <span class="hljs-built_in">to</span> connect <span class="hljs-keyword">with</span> (scheme://ip:port), <span class="hljs-literal">comma</span> separated.<br><span class="hljs-comment">--etcd-servers-overrides stringSlice</span><br>Per-resource etcd servers overrides, <span class="hljs-literal">comma</span> separated. The individual override <span class="hljs-built_in">format</span>: group/resource<span class="hljs-comment">#servers, where servers are URLs,</span><br>semicolon separated.<br><br></code></pre></td></tr></table></figure>

<p>另一方面，我们未看到任何标签相关的key。Kubernetes实现标签查询的方式显然是方案二，即由kube-apiserver通过范围遍历etcd获取原始数据，然后基于用户指定标签，来筛选符合条件的资源返回给client（资源key的value中记录了资源YAML文件内容等，如标签）。</p>
<p>也就是当执行”kubectl get po -l app&#x3D;nginx”命令，按标签查询Pod时，它会向etcd发起一个范围遍历整个default namespace下的Pod操作。</p>
<figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs awk">$ kubectl get po -l app=nginx -v <span class="hljs-number">8</span><br>I0301 <span class="hljs-number">23</span>:<span class="hljs-number">45</span>:<span class="hljs-number">25.597465</span>   <span class="hljs-number">32411</span> loader.go:<span class="hljs-number">359</span>] Config loaded from file <span class="hljs-regexp">/root/</span>.kube/config<br>I0301 <span class="hljs-number">23</span>:<span class="hljs-number">45</span>:<span class="hljs-number">25.603182</span>   <span class="hljs-number">32411</span> round_trippers.go:<span class="hljs-number">416</span>] GET https:<span class="hljs-regexp">//i</span>p:port<span class="hljs-regexp">/api/</span>v1<span class="hljs-regexp">/namespaces/</span>default/pods?<br>labelSelector=app%<span class="hljs-number">3</span>Dnginx&amp;limit=<span class="hljs-number">500</span><br><br></code></pre></td></tr></table></figure>

<p>etcd收到的请求日志如下，由此可见当一个namespace存在大量Pod等资源时，若频繁通过kubectl，使用标签查询Pod等资源，后端etcd将出现较大的压力。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&#123;<br>    <span class="hljs-string">&quot;level&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;debug&quot;</span></span>,<br>    <span class="hljs-string">&quot;ts&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-03-01T23:45:25.609+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;caller&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;v3rpc/interceptor.go:181&quot;</span></span>,<br>    <span class="hljs-string">&quot;msg&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;request stats&quot;</span></span>,<br>    <span class="hljs-string">&quot;start time&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-03-01T23:45:25.608+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;time spent&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;1.414135ms&quot;</span></span>,<br>    <span class="hljs-string">&quot;remote&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;127.0.0.1:44664&quot;</span></span>,<br>    <span class="hljs-string">&quot;response type&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;/etcdserverpb.KV/Range&quot;</span></span>,<br>    <span class="hljs-string">&quot;request count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;request size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">61</span>,<br>    <span class="hljs-string">&quot;response count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">11</span>,<br>    <span class="hljs-string">&quot;response size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">81478</span>,<br>    <span class="hljs-string">&quot;request content&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;key:&quot;</span>/registry/pods/default/<span class="hljs-string">&quot; range_end:&quot;</span>/registry/pods/default0<span class="hljs-string">&quot; limit:500 &quot;</span></span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>了解完Kubernetes资源的存储格式后，我们再看看nginx Deployment资源是如何由kube-apiserver写入etcd的。</p>
<h2 id="通用存储模块"><a href="#通用存储模块" class="headerlink" title="通用存储模块"></a>通用存储模块</h2><p>kube-apiserver启动的时候，会将每个资源的APIGroup、Version、Resource Handler注册到路由上。当请求经过认证、限速、授权、准入控制模块检查后，请求就会被转发到对应的资源逻辑进行处理。</p>
<p>同时，kube-apiserver实现了类似数据库ORM机制的通用资源存储机制，提供了对一个资源创建、更新、删除前后的hook能力，将其封装成策略接口。当你新增一个资源时，你只需要编写相应的创建、更新、删除等策略即可，不需要写任何etcd的API。</p>
<p>下面是kube-apiserver通用存储模块的创建流程图：</p>
<p><img src="https://static001.geekbang.org/resource/image/4d/09/4d8fa0f1d6afd89cf6463cf22c56b709.png?wh=1920*1178" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>从图中可以看到，创建一个资源主要由BeforeCreate、Storage.Create以及AfterCreate三大步骤组成。</p>
<p>当收到创建nginx Deployment请求后，通用存储模块首先会回调各个资源自定义实现的BeforeCreate策略，为资源写入etcd做一些初始化工作。</p>
<p>下面是Deployment资源的创建策略实现，它会进行将deployment.Generation设置为1等操作。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// PrepareForCreate clears fields that are not allowed to be set by end users on creation.</span><br>func (deploymentStrategy) <span class="hljs-built_in">PrepareForCreate</span>(ctx context<span class="hljs-selector-class">.Context</span>, obj runtime.Object) &#123;<br>   deployment := obj.(*apps.Deployment)<br>   deployment<span class="hljs-selector-class">.Status</span> = apps.DeploymentStatus&#123;&#125;<br>   deployment<span class="hljs-selector-class">.Generation</span> = <span class="hljs-number">1</span><br><br>   pod<span class="hljs-selector-class">.DropDisabledTemplateFields</span>(&amp;deployment<span class="hljs-selector-class">.Spec</span><span class="hljs-selector-class">.Template</span>, nil)<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>执行完BeforeCreate策略后，它就会执行Storage.Create接口，也就是由它真正开始调用底层存储模块etcd3，将nginx Deployment资源对象写入etcd。</p>
<p>那么Kubernetes是使用etcd Put接口写入资源key-value的吗？如果是，那要如何防止同名资源并发创建被覆盖的问题？</p>
<h3 id="资源安全创建及更新"><a href="#资源安全创建及更新" class="headerlink" title="资源安全创建及更新"></a>资源安全创建及更新</h3><p>我们知道etcd提供了Put和Txn接口给业务添加key-value数据，但是Put接口在并发场景下若收到key相同的资源创建，就会导致被覆盖。</p>
<p>因此Kubernetes很显然无法直接通过etcd Put接口来写入数据。</p>
<p>etcd的事务接口Txn，它正是为了多key原子更新、并发操作安全性等而诞生的，它提供了丰富的冲突检查机制。</p>
<p>Kubernetes集群使用的正是事务Txn接口来防止并发创建、更新被覆盖等问题。当执行完BeforeCreate策略后，这时kube-apiserver就会调用Storage的模块的Create接口写入资源。1.6版本后的Kubernete集群默认使用的存储是etcd3，它的创建接口简要实现如下：</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs stylus"><span class="hljs-comment">// Create implements storage.Interface.Create.</span><br>func (s *store) <span class="hljs-built_in">Create</span>(ctx context<span class="hljs-selector-class">.Context</span>, key string, obj, out runtime<span class="hljs-selector-class">.Object</span>, ttl uint64) error &#123;<br>   ......<br>   key = path<span class="hljs-selector-class">.Join</span>(s<span class="hljs-selector-class">.pathPrefix</span>, key)<br><br>   opts, err := s<span class="hljs-selector-class">.ttlOpts</span>(ctx, <span class="hljs-built_in">int64</span>(ttl))<br>   <span class="hljs-keyword">if</span> err != nil &#123;<br>      return err<br>   &#125;<br><br>   newData, err := s<span class="hljs-selector-class">.transformer</span><span class="hljs-selector-class">.TransformToStorage</span>(data, <span class="hljs-built_in">authenticatedDataString</span>(key))<br>   <span class="hljs-keyword">if</span> err != nil &#123;<br>      return storage<span class="hljs-selector-class">.NewInternalError</span>(err<span class="hljs-selector-class">.Error</span>())<br>   &#125;<br><br>   startTime := <span class="hljs-selector-tag">time</span><span class="hljs-selector-class">.Now</span>()<br>   txnResp, err := s<span class="hljs-selector-class">.client</span><span class="hljs-selector-class">.KV</span><span class="hljs-selector-class">.Txn</span>(ctx)<span class="hljs-selector-class">.If</span>(<br>      <span class="hljs-built_in">notFound</span>(key),<br>   )<span class="hljs-selector-class">.Then</span>(<br>      clientv3<span class="hljs-selector-class">.OpPut</span>(key, <span class="hljs-built_in">string</span>(newData), opts...),<br>   )<span class="hljs-selector-class">.Commit</span><br><br></code></pre></td></tr></table></figure>

<p>从上面的代码片段中，我们可以得出首先它会按照我们介绍的Kubernetes资源存储格式拼接key。</p>
<p>然后若TTL非0，它会根据TTL从leaseManager获取可复用的Lease ID。Kubernetes集群默认若不同key（如Kubernetes的Event资源对象）的TTL差异在1分钟内，可复用同一个Lease ID，避免大量Lease影响etcd性能和稳定性。</p>
<p>其次若开启了数据加密，在写入etcd前数据还将按加密算法进行转换工作。</p>
<p>最后就是使用etcd的Txn接口，向etcd发起一个创建deployment资源的Txn请求。</p>
<p>那么etcd收到kube-apiserver的请求是长什么样子的呢？</p>
<p>下面是etcd收到创建nginx deployment资源的请求日志：</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&#123;<br>    <span class="hljs-string">&quot;level&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;debug&quot;</span></span>,<br>    <span class="hljs-string">&quot;ts&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-02-11T09:55:45.914+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;caller&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;v3rpc/interceptor.go:181&quot;</span></span>,<br>    <span class="hljs-string">&quot;msg&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;request stats&quot;</span></span>,<br>    <span class="hljs-string">&quot;start time&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-02-11T09:55:45.911+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;time spent&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2.697925ms&quot;</span></span>,<br>    <span class="hljs-string">&quot;remote&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;127.0.0.1:44822&quot;</span></span>,<br>    <span class="hljs-string">&quot;response type&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;/etcdserverpb.KV/Txn&quot;</span></span>,<br>    <span class="hljs-string">&quot;request count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;request size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">479</span>,<br>    <span class="hljs-string">&quot;response count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;response size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">44</span>,<br>    <span class="hljs-string">&quot;request content&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;compare:&lt;target:MOD key:&quot;</span>/registry/deployments/default/nginx-deployment<span class="hljs-string">&quot; mod_revision:0 &gt; success:&lt;request_put:&lt;key:&quot;</span>/registry/deployments/default/nginx-deployment<span class="hljs-string">&quot; value_size:421 &gt;&gt; failure:&lt;&gt;&quot;</span></span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>从这个请求日志中，你可以得到以下信息：</p>
<ul>
<li>请求的模块和接口，KV&#x2F;Txn；</li>
<li>key路径，&#x2F;registry&#x2F;deployments&#x2F;default&#x2F;nginx-deployment，由prefix + “&#x2F;“ + 资源类型 + “&#x2F;“ + namespace + “&#x2F;“ + 具体资源名组成；</li>
<li>安全的并发创建检查机制，mod_revision为0时，也就是此key不存在时，才允许执行put更新操作。</li>
</ul>
<p>通过Txn接口成功将数据写入到etcd后，kubectl create -f nginx.yml命令就执行完毕，返回给client了。在以上介绍中你可以看到，kube-apiserver并没有任何逻辑去真正创建Pod，但是为什么我们可以马上通过kubectl get命令查询到新建并成功运行的Pod呢？</p>
<p>这就涉及到了基础架构图中的控制器、调度器、Kubelet等组件。下面我就为你浅析它们是如何基于etcd提供的Watch机制工作，最终实现创建Pod、调度Pod、运行Pod的。</p>
<h2 id="Watch机制在Kubernetes中应用"><a href="#Watch机制在Kubernetes中应用" class="headerlink" title="Watch机制在Kubernetes中应用"></a>Watch机制在Kubernetes中应用</h2><p>正如基础架构中所介绍的，kube-controller-manager组件中包含一系列WorkLoad的控制器。Deployment资源就由其中的Deployment控制器来负责的，那么它又是如何感知到新建Deployment资源，最终驱动ReplicaSet控制器创建出Pod的呢？</p>
<p>获取数据变化的方案，主要有轮询和推送两种方案组成。轮询会产生大量expensive request，并且存在高延时。而etcd Watch机制提供的流式推送能力，赋予了kube-apiserver对外提供数据监听能力。</p>
<p>我们知道在etcd中版本号是个逻辑时钟，随着client对etcd的增、删、改操作而全局递增，它被广泛应用在MVCC、事务、Watch特性中。</p>
<p>尤其是在Watch特性中，版本号是数据增量同步的核心。当client因网络等异常出现连接闪断后，它就可以通过版本号从etcd server中快速获取异常后的事件，无需全量同步。</p>
<p>那么在Kubernetes集群中，它提供了什么概念来实现增量监听逻辑呢？</p>
<p>答案是<strong>Resource Version</strong>。</p>
<h3 id="Resource-Version与etcd版本号"><a href="#Resource-Version与etcd版本号" class="headerlink" title="Resource Version与etcd版本号"></a>Resource Version与etcd版本号</h3><p>Resource Version是Kubernetes API中非常重要的一个概念，顾名思义，它是一个Kubernetes资源的内部版本字符串，client可通过它来判断资源是否发生了变化。同时，你可以在Get、List、Watch接口中，通过指定Resource Version值来满足你对数据一致性、高性能等诉求。</p>
<p>那么Resource Version有哪些值呢？跟etcd版本号是什么关系？</p>
<p>下面我分别以Get和Watch接口中的Resource Version参数值为例，为你剖析它与etcd的关系。</p>
<p>在Get请求查询案例中，ResourceVersion主要有以下这三种取值：</p>
<p>第一种是未指定ResourceVersion，默认空字符串。kube-apiserver收到一个此类型的读请求后，它会向etcd发出共识读&#x2F;线性读请求获取etcd集群最新的数据。</p>
<p>第二种是设置ResourceVersion&#x3D;”0”，赋值字符串0。kube-apiserver收到此类请求时，它可能会返回任意资源版本号的数据，但是优先返回较新版本。一般情况下它直接从kube-apiserver缓存中获取数据返回给client，有可能读到过期的数据，适用于对数据一致性要求不高的场景。</p>
<p>第三种是设置ResourceVersion为一个非0的字符串。kube-apiserver收到此类请求时，它会保证Cache中的最新ResourceVersion大于等于你传入的ResourceVersion，然后从Cache中查找你请求的资源对象key，返回数据给client。基本原理是kube-apiserver为各个核心资源（如Pod）维护了一个Cache，通过etcd的Watch机制来实时更新Cache。当你的Get请求中携带了非0的ResourceVersion，它会等待缓存中最新ResourceVersion大于等于你Get请求中的ResoureVersion，若满足条件则从Cache中查询数据，返回给client。若不满足条件，它最多等待3秒，若超过3秒，Cache中的最新ResourceVersion还小于Get请求中的ResourceVersion，就会返回ResourceVersionTooLarge错误给client。</p>
<p>你要注意的是，若你使用的Get接口，那么kube-apiserver会取资源key的ModRevision字段填充Kubernetes资源的ResourceVersion字段（v1.meta&#x2F;ObjectMeta.ResourceVersion）。若你使用的是List接口，kube-apiserver会在查询时，使用etcd当前版本号填充ListMeta.ResourceVersion字段（v1.meta&#x2F;ListMeta.ResourceVersion）。</p>
<p>那么当我们执行kubectl get po查询案例时，它的ResouceVersion是什么取值呢? 查询的是kube-apiserver缓存还是etcd最新共识数据?</p>
<p>如下所示，可以通过指定kubectl日志级别为6，观察它向kube-apiserver发出的请求参数。从下面请求日志里你可以看到，默认是未指定Resource Version，也就是会发出一个共识读&#x2F;线性读请求给etcd，获取etcd最新共识数据。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs elixir">kubectl get po -l app=nginx -v <span class="hljs-number">6</span><br><span class="hljs-number">4410</span> <span class="hljs-symbol">loader.go:</span><span class="hljs-number">359</span>] <span class="hljs-title class_">Config</span> loaded from file /root/.kube/config<br><span class="hljs-number">4410</span> <span class="hljs-symbol">round_trippers.go:</span><span class="hljs-number">438</span>] <span class="hljs-title class_">GET</span> <span class="hljs-symbol">https:</span>//*.*.*.*<span class="hljs-symbol">:*/api/v1/namespaces/default/pods?labelSelector=app%</span><span class="hljs-number">3</span>Dnginx&amp;limit=<span class="hljs-number">500</span> <span class="hljs-number">200</span> <span class="hljs-title class_">OK</span> <span class="hljs-keyword">in</span> <span class="hljs-number">8</span> milliseconds<br><br></code></pre></td></tr></table></figure>

<p>这里需要注意，在规模较大的集群中，尽量不要使用kubectl频繁查询资源。正如上面所分析的，它会直接查询etcd数据，可能会产生大量的expensive request请求，之前我就有见过业务这样用，然后导致了集群不稳定。</p>
<p>介绍完查询案例后，我们再看看Watch案例中，它的不同取值含义是怎样的呢?</p>
<p>它同样含有查询案例中的三种取值，官方定义的含义分别如下：</p>
<ul>
<li>未指定ResourceVersion，默认空字符串。一方面为了帮助client建立初始状态，它会将当前已存在的资源通过Add事件返回给client。另一方面，它会从etcd当前版本号开始监听，后续新增写请求导致数据变化时可及时推送给client。</li>
<li>设置ResourceVersion&#x3D;”0”，赋值字符串0。它同样会帮助client建立初始状态，但是它会从任意版本号开始监听（当前kube-apiserver的实现指定ResourceVersion&#x3D;0和不指定行为一致，在获取初始状态后，都会从cache最新的ResourceVersion开始监听），这种场景可能会导致集群返回陈旧的数据。</li>
<li>设置ResourceVersion为一个非0的字符串。从精确的版本号开始监听数据，它只会返回大于等于精确版本号的变更事件。</li>
</ul>
<p>Kubernetes的控制器组件就基于以上的Watch特性，在快速感知到新建Deployment资源后，进入一致性协调逻辑，创建ReplicaSet控制器，整体交互流程如下所示。</p>
<p><img src="https://static001.geekbang.org/resource/image/89/54/89c610a5e5bc2bf5eda466a5a0e18e54.png?wh=1740*1456" srcset="/img/loading.gif" lazyload alt="img"></p>
<p>Deployment控制器创建ReplicaSet资源对象的日志如下所示。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&#123;<br>    <span class="hljs-string">&quot;level&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;debug&quot;</span></span>,<br>    <span class="hljs-string">&quot;ts&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-02-11T09:55:45.923+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;caller&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;v3rpc/interceptor.go:181&quot;</span></span>,<br>    <span class="hljs-string">&quot;msg&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;request stats&quot;</span></span>,<br>    <span class="hljs-string">&quot;start time&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-02-11T09:55:45.917+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;time spent&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;5.922089ms&quot;</span></span>,<br>    <span class="hljs-string">&quot;remote&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;127.0.0.1:44828&quot;</span></span>,<br>    <span class="hljs-string">&quot;response type&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;/etcdserverpb.KV/Txn&quot;</span></span>,<br>    <span class="hljs-string">&quot;request count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;request size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">766</span>,<br>    <span class="hljs-string">&quot;response count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;response size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">44</span>,<br>    <span class="hljs-string">&quot;request content&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;compare:&lt;target:MOD key:&quot;</span>/registry/replicasets/default/nginx-deployment-</span><span class="hljs-number">756</span>d9fd5f9<span class="hljs-string">&quot; mod_revision:0 &gt; success:&lt;request_put:&lt;key:&quot;</span>/registry/replicasets/default/nginx-deployment<span class="hljs-number">-756</span>d9fd5f9<span class="hljs-string">&quot; value_size:697 &gt;&gt; failure:&lt;&gt;&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>真正创建Pod则是由ReplicaSet控制器负责，它同样基于Watch机制感知到新的RS资源创建后，发起请求创建Pod，确保实际运行Pod数与期望一致。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&#123;<br>    <span class="hljs-string">&quot;level&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;debug&quot;</span></span>,<br>    <span class="hljs-string">&quot;ts&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-02-11T09:55:46.023+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;caller&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;v3rpc/interceptor.go:181&quot;</span></span>,<br>    <span class="hljs-string">&quot;msg&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;request stats&quot;</span></span>,<br>    <span class="hljs-string">&quot;start time&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-02-11T09:55:46.019+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;time spent&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;3.519326ms&quot;</span></span>,<br>    <span class="hljs-string">&quot;remote&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;127.0.0.1:44664&quot;</span></span>,<br>    <span class="hljs-string">&quot;response type&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;/etcdserverpb.KV/Txn&quot;</span></span>,<br>    <span class="hljs-string">&quot;request count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;request size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">822</span>,<br>    <span class="hljs-string">&quot;response count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;response size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">44</span>,<br>    <span class="hljs-string">&quot;request content&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;compare:&lt;target:MOD key:&quot;</span>/registry/pods/default/nginx-deployment-</span><span class="hljs-number">756</span>d9fd5f9-x6r6q<span class="hljs-string">&quot; mod_revision:0 &gt; success:&lt;request_put:&lt;key:&quot;</span>/registry/pods/default/nginx-deployment<span class="hljs-number">-756</span>d9fd5f9-x6r6q<span class="hljs-string">&quot; value_size:754 &gt;&gt; failure:&lt;&gt;&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>在这过程中也产生了若干Event，下面是etcd收到新增Events资源的请求，你可以看到Event事件key关联了Lease，这个Lease正是由我上面所介绍的leaseManager所负责创建。</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs elixir">&#123;<br>    <span class="hljs-string">&quot;level&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;debug&quot;</span></span>,<br>    <span class="hljs-string">&quot;ts&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-02-11T09:55:45.930+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;caller&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;v3rpc/interceptor.go:181&quot;</span></span>,<br>    <span class="hljs-string">&quot;msg&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;request stats&quot;</span></span>,<br>    <span class="hljs-string">&quot;start time&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;2021-02-11T09:55:45.926+0800&quot;</span></span>,<br>    <span class="hljs-string">&quot;time spent&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;3.259966ms&quot;</span></span>,<br>    <span class="hljs-string">&quot;remote&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;127.0.0.1:44632&quot;</span></span>,<br>    <span class="hljs-string">&quot;response type&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;/etcdserverpb.KV/Txn&quot;</span></span>,<br>    <span class="hljs-string">&quot;request count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">1</span>,<br>    <span class="hljs-string">&quot;request size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">449</span>,<br>    <span class="hljs-string">&quot;response count&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">0</span>,<br>    <span class="hljs-string">&quot;response size&quot;</span><span class="hljs-symbol">:</span><span class="hljs-number">44</span>,<br>    <span class="hljs-string">&quot;request content&quot;</span><span class="hljs-symbol">:<span class="hljs-string">&quot;compare:&lt;target:MOD key:&quot;</span>/registry/events/default/nginx-deployment</span>.<span class="hljs-number">16628</span>eb9f79e0ab0<span class="hljs-string">&quot; mod_revision:0 &gt; success:&lt;request_put:&lt;key:&quot;</span>/registry/events/default/nginx-deployment.<span class="hljs-number">16628</span>eb9f79e0ab0<span class="hljs-string">&quot; value_size:369 lease:5772338802590698925 &gt;&gt; failure:&lt;&gt;&quot;</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>Pod创建出来后，这时kube-scheduler监听到待调度的Pod，于是为其分配Node，通过kube-apiserver的Bind接口，将调度后的节点IP绑定到Pod资源上。kubelet通过同样的Watch机制感知到新建的Pod后，发起Pod创建流程即可。</p>
<p>以上就是当我们在Kubernetes集群中创建一个Pod后，Kubernetes和etcd之间交互的简要分析。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>最后首先解读了Kubernetes集群的etcd存储格式，每个资源的保存路径为prefix + “&#x2F;“ + 资源类型 + “&#x2F;“ + namespace + “&#x2F;“ + 具体资源名组成。结合etcd3的范围查询，可快速实现按namesapace、资源名称查询。按标签查询则是通过kube-apiserver遍历指定namespace下的资源实现的，若未从kube-apiserver的Cache中查询，请求较频繁，很可能导致etcd流量较大，出现不稳定。</p>
<p>随后介绍了kube-apiserver的通用存储模块，它通过在创建、查询、删除、更新操作前增加一系列的Hook机制，实现了新增任意资源只需编写相应的Hook策略即可。我还重点和你介绍了创建接口，它主要由拼接key、获取Lease ID、数据转换、写入etcd组成，重点是它通过使用事务接口实现了资源的安全创建及更新。</p>
<p>最后讲解了Resoure Version在Kubernetes集群中的大量应用，重点分析了Get和Watch请求案例中的Resource Version含义，帮助你了解Resource Version本质，让你能根据业务场景和对一致性的容忍度，正确的使用Resource Version以满足业务诉求。</p>
<h2 id="思考题"><a href="#思考题" class="headerlink" title="思考题"></a>思考题</h2><p>有哪些原因可能会导致kube-apiserver报“too old Resource Version”错误呢？</p>
<p>informer watch请求的resource version比kube-apiserver缓存中保存的最小resource version还小，kube-apiserver就会返回“too old Resource Version”，然后触发informer进行list全量数据，导致expensive request</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/etcd/" class="category-chain-item">etcd</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E5%8E%9F%E5%88%9B/">#原创</a>
      
        <a href="/tags/Kubernetes/">#Kubernetes</a>
      
        <a href="/tags/etcd/">#etcd</a>
      
        <a href="/tags/%E7%AC%94%E8%AE%B0/">#笔记</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>19.Kubernetes基础应用：创建一个Pod背后etcd发生了什么？</div>
      <div>https://blog.longpi1.com/2022/10/15/19-Kubernetes基础应用：创建一个Pod背后etcd发生了什么？/</div>
    </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/10/15/20-Kubernetes%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8%EF%BC%9A%E5%A6%82%E4%BD%95%E4%BC%98%E5%8C%96%E4%B8%9A%E5%8A%A1%E5%9C%BA%E6%99%AF%E4%BD%BFetcd%E8%83%BD%E6%94%AF%E6%92%91%E4%B8%8A%E4%B8%87%E8%8A%82%E7%82%B9%E9%9B%86%E7%BE%A4%EF%BC%9F/" title="20.Kubernetes高级应用：如何优化业务场景使etcd能支撑上万节点集群？">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">20.Kubernetes高级应用：如何优化业务场景使etcd能支撑上万节点集群？</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/10/12/18-%E5%AE%9E%E6%88%98%EF%BC%9A%E5%A6%82%E4%BD%95%E5%9F%BA%E4%BA%8ERaft%E4%BB%8E0%E5%88%B01%E6%9E%84%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%94%AF%E6%8C%81%E5%A4%9A%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%88%86%E5%B8%83%E5%BC%8FKV%E6%9C%8D%E5%8A%A1%EF%BC%9F/" title="18.实战：如何基于Raft从0到1构建一个支持多存储引擎分布式KV服务？">
                        <span class="hidden-mobile">18.实战：如何基于Raft从0到1构建一个支持多存储引擎分布式KV服务？</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  <article id="comments" lazyload>
    
  <div id="valine"></div>
  <script type="text/javascript">
    Fluid.utils.loadComments('#valine', function() {
      Fluid.utils.createScript('https://lib.baomitu.com/valine/1.4.17/Valine.min.js', function() {
        var options = Object.assign(
          {"appId":"UvaCwj6C0pVj9XCWuMtLaBWJ-gzGzoHsz","appKey":"w2xUk9wycItSqrREmRMDYJHY","path":"window.location.pathname","placeholder":null,"avatar":"retro","meta":["nick","mail","link"],"requiredFields":[],"pageSize":10,"lang":"zh-CN","highlight":false,"recordIP":false,"serverURLs":"","emojiCDN":null,"emojiMaps":null,"enableQQ":false},
          {
            el: "#valine",
            path: window.location.pathname
          }
        )
        new Valine(options);
        Fluid.utils.waitElementVisible('#valine .vcontent', () => {
          var imgSelector = '#valine .vcontent img:not(.vemoji)';
          Fluid.plugins.imageCaption(imgSelector);
          Fluid.plugins.fancyBox(imgSelector);
        })
      });
    });
  </script>
  <noscript>Please enable JavaScript to view the comments</noscript>


  </article>


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <div>lp的个人博客 | 记录成长的过程</div> 
    </div>
  
  
    <div class="statistics">
  
  

  
    
      <span id="leancloud-site-pv-container" style="display: none">
        总访问量 
        <span id="leancloud-site-pv"></span>
         次
      </span>
    

    

  
</div>

  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script defer src="/js/leancloud.js" ></script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
